/** @jsxImportSource @systembug/wsx-core */
/**
 * å“åº”å¼è®¡æ•°å™¨ç»„ä»¶ - å±•ç¤º WSX å“åº”å¼çŠ¶æ€ç³»ç»Ÿ
 *
 * è¿™ä¸ªç»„ä»¶æ¼”ç¤ºäº†ï¼š
 * - è‡ªåŠ¨é‡æ¸²æŸ“ï¼šçŠ¶æ€å˜åŒ–æ—¶æ— éœ€æ‰‹åŠ¨è°ƒç”¨ rerender()
 * - æ‰¹é‡æ›´æ–°ï¼šå¤šä¸ªçŠ¶æ€å˜åŒ–ä¼šè¢«åˆå¹¶ä¸ºä¸€æ¬¡é‡æ¸²æŸ“
 * - åŸç”Ÿæ€§èƒ½ï¼šåŸºäºæµè§ˆå™¨ Proxy APIï¼Œé›¶è¿è¡Œæ—¶å¼€é”€
 */

import { ReactiveWebComponent, autoRegister, createLogger } from "@systembug/wsx-core";
import styles from "./ReactiveCounter.css?inline";

const logger = createLogger("ReactiveCounter");

@autoRegister({ tagName: "reactive-counter" })
export default class ReactiveCounter extends ReactiveWebComponent {
    // ä½¿ç”¨å“åº”å¼å¯¹è±¡ - ä»»ä½•å±æ€§å˜åŒ–éƒ½ä¼šè‡ªåŠ¨è§¦å‘é‡æ¸²æŸ“
    private state = this.reactive({
        count: 0,
        step: 1,
        message: "Hello WSX Reactive!",
        isRunning: false,
    });

    // ä½¿ç”¨ useState API - ç±»ä¼¼ React çš„ useState
    private themeState = this.useState("theme", "light");
    private historyState = this.useState("history", [] as number[]);

    private getTheme = this.themeState[0];
    private setTheme = this.themeState[1];
    private getHistory = this.historyState[0];
    private setHistory = this.historyState[1];

    constructor() {
        super({
            styles,
            debug: true, // å¯ç”¨è°ƒè¯•æ¨¡å¼
        });

        logger.info("ReactiveCounter initialized");
    }

    render() {
        const theme = this.getTheme();
        const history = this.getHistory();

        return (
            <div class={`reactive-counter theme-${theme}`}>
                <div class="header">
                    <h3>ğŸ”„ Reactive Counter</h3>
                    <p class="subtitle">{this.state.message}</p>
                </div>

                <div class="counter-display">
                    <div class="count-value">{this.state.count}</div>
                    <div class="step-info">Step: {this.state.step}</div>
                </div>

                <div class="controls">
                    <button
                        class="btn btn-primary"
                        onClick={this.increment}
                        disabled={this.state.isRunning}
                    >
                        +{this.state.step}
                    </button>

                    <button
                        class="btn btn-secondary"
                        onClick={this.decrement}
                        disabled={this.state.isRunning}
                    >
                        -{this.state.step}
                    </button>

                    <button
                        class="btn btn-warning"
                        onClick={this.reset}
                        disabled={this.state.isRunning}
                    >
                        Reset
                    </button>
                </div>

                <div class="step-controls">
                    <label>
                        Step Size:
                        <input
                            type="range"
                            min="1"
                            max="10"
                            value={this.state.step}
                            onInput={this.handleStepChange}
                        />
                        <span>{this.state.step}</span>
                    </label>
                </div>

                <div class="auto-controls">
                    <button
                        class={`btn ${this.state.isRunning ? "btn-danger" : "btn-success"}`}
                        onClick={this.toggleAutoIncrement}
                    >
                        {this.state.isRunning ? "Stop" : "Start"} Auto Increment
                    </button>
                </div>

                <div class="theme-controls">
                    <label>
                        Theme:
                        <select value={theme} onChange={this.handleThemeChange}>
                            <option value="light">Light</option>
                            <option value="dark">Dark</option>
                            <option value="blue">Blue</option>
                        </select>
                    </label>
                </div>

                <div class="message-controls">
                    <input
                        type="text"
                        value={this.state.message}
                        onInput={this.handleMessageChange}
                        placeholder="Enter a message..."
                    />
                </div>

                {history.length > 0 && (
                    <div class="history">
                        <h4>History (last 10):</h4>
                        <div class="history-list">
                            {history.slice(-10).map((value, index) => (
                                <span key={index} class="history-item">
                                    {value}
                                </span>
                            ))}
                        </div>
                        <button class="btn btn-sm" onClick={this.clearHistory}>
                            Clear History
                        </button>
                    </div>
                )}

                <div class="debug-info">
                    <details>
                        <summary>Debug Info</summary>
                        <pre>
                            {JSON.stringify(
                                {
                                    state: this.state,
                                    theme: this.getTheme(),
                                    historyLength: this.getHistory().length,
                                    stateSnapshot: this.getStateSnapshot(),
                                },
                                null,
                                2
                            )}
                        </pre>
                    </details>
                </div>
            </div>
        );
    }

    // äº‹ä»¶å¤„ç†æ–¹æ³• - ç›´æ¥ä¿®æ”¹çŠ¶æ€ï¼Œè‡ªåŠ¨è§¦å‘é‡æ¸²æŸ“
    private increment = () => {
        this.state.count += this.state.step;
        this.addToHistory(this.state.count);
    };

    private decrement = () => {
        this.state.count -= this.state.step;
        this.addToHistory(this.state.count);
    };

    private reset = () => {
        this.state.count = 0;
        this.addToHistory(0);
    };

    private handleStepChange = (event: Event) => {
        const input = event.target as HTMLInputElement;
        this.state.step = parseInt(input.value);
    };

    private handleThemeChange = (event: Event) => {
        const select = event.target as HTMLSelectElement;
        this.setTheme(select.value);
    };

    private handleMessageChange = (event: Event) => {
        const input = event.target as HTMLInputElement;
        this.state.message = input.value;
    };

    private toggleAutoIncrement = () => {
        this.state.isRunning = !this.state.isRunning;

        if (this.state.isRunning) {
            this.startAutoIncrement();
        }
    };

    private startAutoIncrement() {
        const interval = setInterval(() => {
            if (!this.state.isRunning) {
                clearInterval(interval);
                return;
            }

            this.increment();

            // æ¼”ç¤ºæ‰¹é‡æ›´æ–°ï¼šè¿™äº›å˜åŒ–ä¼šè¢«åˆå¹¶ä¸ºä¸€æ¬¡é‡æ¸²æŸ“
            if (this.state.count % 5 === 0) {
                this.state.message = `Count reached ${this.state.count}!`;
            }
        }, 200);
    }

    private addToHistory(value: number) {
        const history = this.getHistory();
        this.setHistory([...history, value]);
    }

    private clearHistory = () => {
        this.setHistory([]);
    };

    protected onConnected(): void {
        logger.info("ReactiveCounter connected to DOM");

        // ç»„ä»¶æŒ‚è½½æ—¶æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
        setTimeout(() => {
            this.state.message = "Ready to count! ğŸš€";
        }, 500);
    }

    protected onDisconnected(): void {
        logger.info("ReactiveCounter disconnected from DOM");
        // æ¸…ç†å®šæ—¶å™¨ç­‰èµ„æº
        this.state.isRunning = false;
    }
}
